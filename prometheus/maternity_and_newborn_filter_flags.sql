set search_path=epbuilder;

select 'Step: maternity_amd_newborn_filter_flags.sql' as curstep, current_timestamp as datetime;
\set AUTOCOMMIT on

drop table if exists ALL_MAT_NBRON_FLAGs;
drop table if exists ALL_MAT_NBRON_FLAGs2;
drop table if exists filters_MAT_NBORN;


create table ALL_MAT_NBRON_FLAGs as
SELECT
u_c_id,
claims_combined.member_id,
left(master_episode_id,6) as episode_id,
assignment.master_episode_id,
claims_combined.master_claim_id,
GROUP_ID,
episode_builder_5_4_003.group.name as RF_NAME,
case when (sum(case when code_value in ('59618', '59620') and nomen in ('CPT','PX','HCPC') then 1
     when code_value in ('64100',	'64101',	'64103',	'64110',	'64111',	'64113',	'66350',	'66351',	'66353',	'65420',	'65421',	'65423',	'65100',	'65101',	'65103',	'65110',	'65111',	'65113',	'65120',	'65121',	'65123',	'65130',	'65131',	'65133',	'65140',	'65141',	'65143',	'65150',	'65151',	'65153',	'65160',	'65161',	'65163',	'65170',	'65171',	'65173',	'65180',	'65181',	'65183',	'65190',	'65191',	'65193',	'65260',	'65261',	'65263',	'66050',	'66051',	'66053',	'66230',	'66231',	'66233',	'67810',	'67811',	'67813',	'7615',	'V272',	'V275',	'V9100',	'V9101',	'V9102',	'V9103',	'V9109',	'V9110',	'V9111',	'V9112',	'V9119',	'V9120',	'V9121',	'V9122',	'V9129',	'V9190',	'V9191',	'V9192',	'V9199',	'65940',	'65941',	'65943',	'65960',	'65961',	'65963',	'V233',	'V2382',	'V2384',	'64420',	'64421',	'65671',	'65681',	'65691',	'65881',	'65891',	'65701',	'65801',	'65811',	'65821',	'65601',	'65621',	'65611',	'65841',	'64121',	'64131',	'64181',	'64191',	'64851',	'64852',	'64861',	'64862',	'64931',	'64932',	'64831',	'64832',	'65951',	'65981',	'65991',	'65501',	'65511',	'65521',	'65531',	'65541',	'65551',	'65561',	'65581',	'67801',	'64631',	'V234 ',	'V2341',	'V2349',	'V235 ',	'64621',	'64622',	'64671',	'67451',	'67452',	'65651',	'64611',	'64612',	'64911',	'64912',	'64921',	'64922',	'64941',	'64942',	'V230 ',	'V231 ',	'V232 ',	'V2342',	'V237 ',	'V238 ',	'V2381',	'V2383',	'V2385',	'V2386',	'V2387',	'V2389',	'V239 ',	'V616',	'V617',	'64201',	'64202',	'64211',	'64212',	'64221',	'64222',	'64231',	'64232',	'64241',	'64242',	'64291',	'64292',	'64251',	'64252',	'64254',	'64261',	'64262',	'64264',	'64271',	'64272',	'64274',	'64731',	'64732',	'64741',	'64742',	'64751',	'64752',	'64761',	'64762',	'64781',	'64782',	'64791',	'64792',	'64801',	'64802',	'64881',	'64882',	'64891',	'64892',	'65661',	'64841',	'64842',	'64511',	'64900',	'64901',	'64902',	'64903',	'V08',	'65630',	'65631',	'65633',	'65970',	'65971',	'65973',	'65920',	'65921',	'65930',	'65931',	'67153')and nomen  ='DX' then 1 else 0 end))>0 then 1 else 0 end  as CSECT_RFs,
case when (sum(case when code_value in ('64100',	'64101',	'64103',	'64110',	'64111',	'64113',	'66350',	'66351',	'66353',	'65221',	'65281',	'65231',	'65241',	'66960',	'66961',	'65200',	'65201',	'65203',	'65420',	'65421',	'65423',	'65100',	'65101',	'65103',	'65110',	'65111',	'65113',	'65120',	'65121',	'65123',	'65130',	'65131',	'65133',	'65140',	'65141',	'65143',	'65150',	'65151',	'65153',	'65160',	'65161',	'65163',	'65170',	'65171',	'65173',	'65180',	'65181',	'65183',	'65190',	'65191',	'65193',	'65260',	'65261',	'65263',	'66050',	'66051',	'66053',	'66230',	'66231',	'66233',	'67810',	'67811',	'67813',	'7615',	'V272',	'V275',	'V9100',	'V9101',	'V9102',	'V9103',	'V9109',	'V9110',	'V9111',	'V9112',	'V9119',	'V9120',	'V9121',	'V9122',	'V9129',	'V9190',	'V9191',	'V9192',	'V9199',	'65940',	'65941',	'65943',	'65960',	'65961',	'65963',	'V233',	'V2382',	'V2384',	'64420',	'64421',	'65671',	'65681',	'65691',	'65881',	'65891',	'65701',	'65801',	'65811',	'65821',	'65400',	'65403',	'65410',	'65413',	'65430',	'65433',	'65440',	'65443',	'65460',	'65463',	'65470',	'65473',	'65480',	'65483',	'65490',	'65493',	'65601',	'65621',	'65611',	'65841',	'64121',	'64131',	'64181',	'64191',	'64851',	'64852',	'64861',	'64862',	'64931',	'64932',	'64831',	'64832',	'65951',	'65981',	'65991',	'65501',	'65511',	'65521',	'65531',	'65541',	'65551',	'65561',	'65581',	'67801',	'64631',	'V234 ',	'V2341',	'V2349',	'V235 ',	'64621',	'64622',	'64671',	'67451',	'67452',	'65651',	'64611',	'64612',	'64911',	'64912',	'64921',	'64922',	'64941',	'64942',	'V230 ',	'V231 ',	'V232 ',	'V2342',	'V237 ',	'V238 ',	'V2381',	'V2383',	'V2385',	'V2386',	'V2387',	'V2389',	'V239 ',	'V616',	'V617',	'64201',	'64202',	'64211',	'64212',	'64221',	'64222',	'64231',	'64232',	'64241',	'64242',	'64291',	'64292',	'64251',	'64252',	'64254',	'64261',	'64262',	'64264',	'64271',	'64272',	'64274',	'64661',	'64662',	'64701',	'64702',	'64711',	'64712',	'64721',	'64722',	'64731',	'64732',	'64741',	'64742',	'64751',	'64752',	'64761',	'64762',	'64781',	'64782',	'64791',	'64792',	'64801',	'64802',	'64881',	'64882',	'64891',	'64892',	'65661',	'64841',	'64842',	'64511',	'64900',	'64901',	'64902',	'64903',	'V08',	'65630',	'65631',	'65633',	'65970',	'65971',	'65973',	'65920',	'65921',	'65930',	'65931',	'67153') and nomen ='DX' then     1
     when code_value in ('7251','7252','7253','7254','59610','59612','59614') and nomen in ('CPT','PX','HCPC') then    1 else 0 end))>0 then 1 else 0 end  as VAGEL_RFs ,
case when (sum(case when code_value in ('64100',	'64101',	'64103',	'64110',	'64111',	'64113',	'66350',	'66351',	'66353',	'05411',	'05412',	'65200',	'65203',	'65420',	'65423',	'65100',	'65103',	'65110',	'65113',	'65120',	'65123',	'65130',	'65133',	'65140',	'65143',	'65150',	'65153',	'65160',	'65163',	'65170',	'65173',	'65180',	'65183',	'65190',	'65193',	'65260',	'65263',	'66050',	'66053',	'66230',	'66233',	'67810',	'67813',	'V272',	'V275',	'V9100',	'V9101',	'V9102',	'V9103',	'V9109',	'V9110',	'V9111',	'V9112',	'V9119',	'V9120',	'V9121',	'V9122',	'V9129',	'V9190',	'V9191',	'V9192',	'V9199',	'64600',	'64601',	'64603',	'65640',	'65643',	'V271',	'V273',	'V274',	'V276',	'V277',	'65940',	'65943',	'65960',	'65963',	'V233',	'V2382',	'V2384',	'64420',	'65670',	'65673',	'65680',	'65683',	'65690',	'65693',	'65880',	'65883',	'65890',	'65893',	'65700',	'65703',	'65800',	'65803',	'65810',	'65813',	'65820',	'65823',	'65400',	'65403',	'65410',	'65413',	'65430',	'65433',	'65440',	'65443',	'65460',	'65463',	'65470',	'65473',	'65480',	'65483',	'65490',	'65493',	'65600',	'65603',	'65620',	'65623',	'65610',	'65613',	'65840',	'65841',	'65843',	'64120',	'64121',	'64123',	'64130',	'64131',	'64133',	'64180',	'64181',	'64183',	'64190',	'64191',	'64193',	'64850',	'64851',	'64852',	'64853',	'64860',	'64861',	'64862',	'64863',	'64930',	'64931',	'64932',	'64933',	'64830',	'64831',	'64832',	'64833',	'65950',	'65953',	'65980',	'65983',	'65990',	'65993',	'65500',	'65503',	'65510',	'65513',	'65520',	'65523',	'65530',	'65533',	'65540',	'65543',	'65550',	'65553',	'65560',	'65563',	'65580',	'65583',	'67800',	'67803',	'64630',	'64631',	'64633',	'V234 ',	'V2341',	'V2349',	'V235 ',	'64620',	'64621',	'64622',	'64623',	'64670',	'64671',	'64673',	'67450',	'67451',	'67452',	'67453',	'65650',	'65651',	'65653',	'64610',	'64611',	'64612',	'64613',	'64910',	'64911',	'64912',	'64913',	'64920',	'64921',	'64922',	'64923',	'64940',	'64941',	'64942',	'64943',	'V230 ',	'V231 ',	'V232 ',	'V2342',	'V237 ',	'V238 ',	'V2381',	'V2383',	'V2385',	'V2386',	'V2387',	'V2389',	'V239 ',	'V616',	'V617',	'64200',	'64203',	'64210',	'64213',	'64220',	'64223',	'64230',	'64233',	'64240',	'64243',	'64290',	'64293',	'64250',	'64253',	'64260',	'64263',	'64270',	'64273',	'64660',	'64662',	'64663',	'64700',	'64703',	'64710',	'64713',	'64720',	'64723',	'64730',	'64733',	'64740',	'64743',	'64750',	'64753',	'64760',	'64763',	'64780',	'64783',	'64790',	'64793',	'64800',	'64803',	'64880',	'64883',	'64890',	'64893',	'65660',	'65663',	'64840',	'64843',	'64500',	'64503',	'64510',	'64513',	'64520',	'64523',	'64000',	'64003',	'64080',	'64083',	'64090',	'64093',	'64400',	'64403',	'64410',	'64413',	'64900',	'64903',	'V08') and nomen ='DX' then   1 else 0 end))>0 then 1 else 0 end  as PREGN_RFs ,
case when (sum(case when  code_value = '0174' and nomen ='REV' then 1 else 0 end))>0 then 1 else 0 end  as NICU_LVL_4

from Test_Stock50K20160804.code
join claims_combined
on Test_Stock50K20160804.code.u_c_id=claims_combined.id
join assignment
on claims_combined.master_claim_id=assignment.master_claim_id
left join episode_builder_5_4_003.code
on Test_Stock50K20160804.code.code_value=episode_builder_5_4_003.code.value and Test_Stock50K20160804.code.nomen=episode_builder_5_4_003.code.TYPE_ID
left join episode_builder_5_4_003.group
on episode_builder_5_4_003.code.GROUP_ID=episode_builder_5_4_003.group.ID
where code_value in ('7251',	'7252',	'7253',	'7254',	'59618',	'59620',	'59610',	'59612',	'59614') and nomen in ('CPT','PX','HCPC') and left(master_episode_id,6) in ('EP1403','EP1404','EX1401','EX1502')
or  code_value in ('64100',	'64101',	'64103',	'64110',	'64111',	'64113',	'66350',	'66351',	'66353',	'05411',	'05412',	'65221',	'65281',	'65231',	'65241',	'66960',	'66961',	'65200',	'65201',	'65203',	'65420',	'65421',	'65423',	'65100',	'65101',	'65103',	'65110',	'65111',	'65113',	'65120',	'65121',	'65123',	'65130',	'65131',	'65133',	'65140',	'65141',	'65143',	'65150',	'65151',	'65153',	'65160',	'65161',	'65163',	'65170',	'65171',	'65173',	'65180',	'65181',	'65183',	'65190',	'65191',	'65193',	'65260',	'65261',	'65263',	'66050',	'66051',	'66053',	'66230',	'66231',	'66233',	'67810',	'67811',	'67813',	'7615',	'V272',	'V275',	'V9100',	'V9101',	'V9102',	'V9103',	'V9109',	'V9110',	'V9111',	'V9112',	'V9119',	'V9120',	'V9121',	'V9122',	'V9129',	'V9190',	'V9191',	'V9192',	'V9199',	'64600',	'64601',	'64603',	'65640',	'65641',	'65643',	'V271',	'V273',	'V274',	'V276',	'V277',	'65940',	'65941',	'65943',	'65960',	'65961',	'65963',	'V233',	'V2382',	'V2384',	'64420',	'64421',	'65670',	'65671',	'65673',	'65680',	'65681',	'65683',	'65690',	'65691',	'65693',	'65880',	'65881',	'65883',	'65890',	'65891',	'65893',	'65700',	'65701',	'65703',	'65800',	'65801',	'65803',	'65810',	'65811',	'65813',	'65820',	'65821',	'65823',	'65400',	'65403',	'65410',	'65413',	'65430',	'65433',	'65440',	'65443',	'65460',	'65463',	'65470',	'65473',	'65480',	'65483',	'65490',	'65493',	'65600',	'65601',	'65603',	'65620',	'65621',	'65623',	'65610',	'65611',	'65613',	'65840',	'65841',	'65843',	'64120',	'64121',	'64123',	'64130',	'64131',	'64133',	'64180',	'64181',	'64183',	'64190',	'64191',	'64193',	'64850',	'64851',	'64852',	'64853',	'64860',	'64861',	'64862',	'64863',	'64930',	'64931',	'64932',	'64933',	'64830',	'64831',	'64832',	'64833',	'65950',	'65951',	'65953',	'65980',	'65981',	'65983',	'65990',	'65991',	'65993',	'65500',	'65501',	'65503',	'65510',	'65511',	'65513',	'65520',	'65521',	'65523',	'65530',	'65531',	'65533',	'65540',	'65541',	'65543',	'65550',	'65551',	'65553',	'65560',	'65561',	'65563',	'65580',	'65581',	'65583',	'67800',	'67801',	'67803',	'64630',	'64631',	'64633',	'V234 ',	'V2341',	'V2349',	'V235 ',	'64620',	'64621',	'64622',	'64623',	'64670',	'64671',	'64673',	'67450',	'67451',	'67452',	'67453',	'65650',	'65651',	'65653',	'64610',	'64611',	'64612',	'64613',	'64910',	'64911',	'64912',	'64913',	'64920',	'64921',	'64922',	'64923',	'64940',	'64941',	'64942',	'64943',	'V230 ',	'V231 ',	'V232 ',	'V2342',	'V237 ',	'V238 ',	'V2381',	'V2383',	'V2385',	'V2386',	'V2387',	'V2389',	'V239 ',	'V616',	'V617',	'64200',	'64201',	'64202',	'64203',	'64210',	'64211',	'64212',	'64213',	'64220',	'64221',	'64222',	'64223',	'64230',	'64231',	'64232',	'64233',	'64240',	'64241',	'64242',	'64243',	'64290',	'64291',	'64292',	'64293',	'64250',	'64251',	'64252',	'64253',	'64254',	'64260',	'64261',	'64262',	'64263',	'64264',	'64270',	'64271',	'64272',	'64273',	'64274',	'64660',	'64661',	'64662',	'64663',	'64700',	'64701',	'64702',	'64703',	'64710',	'64711',	'64712',	'64713',	'64720',	'64721',	'64722',	'64723',	'64730',	'64731',	'64732',	'64733',	'64740',	'64741',	'64742',	'64743',	'64750',	'64751',	'64752',	'64753',	'64760',	'64761',	'64762',	'64763',	'64780',	'64781',	'64782',	'64783',	'64790',	'64791',	'64792',	'64793',	'64800',	'64801',	'64802',	'64803',	'64880',	'64881',	'64882',	'64883',	'64890',	'64891',	'64892',	'64893',	'65660',	'65661',	'65663',	'64840',	'64841',	'64842',	'64843',	'64500',	'64503',	'64510',	'64511',	'64513',	'64520',	'64523',	'64000',	'64003',	'64080',	'64083',	'64090',	'64093',	'64400',	'64403',	'64410',	'64413',	'64900',	'64901',	'64902',	'64903',	'V08',	'65630',	'65631',	'65633',	'65970',	'65971',	'65973',	'65920',	'65921',	'65930',	'65931',	'67153') and nomen ='DX' and left(master_episode_id,6) in ('EP1403','EP1404','EX1401','EX1502')
or  code_value = '0174' and nomen ='REV' and left(master_episode_id,6) in ('EP1403','EP1404','EX1401','EX1502')
group by u_c_id,
claims_combined.member_id,
left(master_episode_id,6) ,
assignment.master_episode_id,
claims_combined.master_claim_id,
GROUP_ID,
episode_builder_5_4_003.group.name 

union

SELECT
u_c_id,
claims_combined.member_id,
left(master_episode_id,6) ,
assignment.master_episode_id,
claims_combined.master_claim_id,
GROUP_ID,
episode_builder_5_4_003.group.name as RF_NAME,
case when (sum(case
     when code_value in ('O4400',	'O4401',	'O4402',	'O4403',	'O4401',	'O4402',	'O4403',	'O4410',	'O4411',	'O4412',	'O4413',	'O4411',	'O4412',	'O4413',	'O458X1',	'O458X2',	'O458X3',	'O4591',	'O4592',	'O4593',	'O45001',	'O45002',	'O45003',	'O45011',	'O45012',	'O45013',	'O45021',	'O45022',	'O45023',	'O45091',	'O45092',	'O45093',	'O46001',	'O46002',	'O46003',	'O46011',	'O46012',	'O46013',	'O46021',	'O46022',	'O46023',	'O46091',	'O46092',	'O46093',	'O670',	'O468X1',	'O468X2',	'O468X3',	'O678',	'O4691',	'O4692',	'O4693',	'O679',	'O10011',	'O10012',	'O10013',	'O1002',	'O10911',	'O10912',	'O10913',	'O1092',	'O1003',	'O10411',	'O10412',	'O10413',	'O1042',	'O1043',	'O10111',	'O10112',	'O10113',	'O1012',	'O10211',	'O10212',	'O10213',	'O1022',	'O10311',	'O10312',	'O10313',	'O1032',	'O111',	'O112',	'O113',	'O1013',	'O131',	'O132',	'O133',	'O161',	'O162',	'O163',	'O131',	'O132',	'O133',	'O1402',	'O1403',	'O1492',	'O1493',	'O1402',	'O1403',	'O1412',	'O1413',	'O1422',	'O1423',	'O1412',	'O1413',	'O1422',	'O1423',	'O1412',	'O1413',	'O1422',	'O1423',	'O1502',	'O1503',	'O151',	'O152',	'O152',	'O111',	'O112',	'O113',	'O152',	'O152',	'O161',	'O162',	'O163',	'O169',	'O6010X0',	'O6012X0',	'O6013X0',	'O6014X0',	'O480',	'O1201',	'O1202',	'O1203',	'O1221',	'O1222',	'O1223',	'O2601',	'O2602',	'O2603',	'O1201',	'O1202',	'O1203',	'O26831',	'O26832',	'O26833',	'O26831',	'O26832',	'O26833',	'O2621',	'O2622',	'O2623',	'O26611',	'O26612',	'O26613',	'O2662',	'O98011',	'O98012',	'O98013',	'O9802',	'O9803',	'O98611',	'O98612',	'O98613',	'O9862',	'O9863',	'O98511',	'O98512',	'O98513',	'O9852',	'O9853',	'O9842',	'O98511',	'O98512',	'O98513',	'O9852',	'O9843',	'O9853',	'O98611',	'O98612',	'O98613',	'O98811',	'O98812',	'O98813',	'O9882',	'O99834',	'O9883',	'O99835',	'O98911',	'O98912',	'O98913',	'O9892',	'O9893',	'O2432',	'O24911',	'O24912',	'O24913',	'O2492',	'O2493',	'O99321',	'O99322',	'O99323',	'O99324',	'O99325',	'O99341',	'O99342',	'O99343',	'O99344',	'O906',	'O99345',	'O99411',	'O99412',	'O99413',	'O9942',	'O9943',	'O99411',	'O99412',	'O99413',	'O9942',	'O9943',	'O24419',	'O24429',	'O99810',	'O99814',	'O99815',	'O252',	'O99284',	'O99285',	'O99330',	'O99331',	'O99332',	'O99333',	'O99334',	'O99335',	'O99331',	'O99332',	'O99333',	'O99211',	'O99212',	'O99213',	'O99214',	'O99215',	'O99841',	'O99842',	'O99843',	'O99844',	'O99845',	'O99111',	'O99112',	'O99113',	'O9912',	'O9913',	'O99351',	'O99352',	'O99353',	'O99354',	'O99355',	'O30009',	'O30001',	'O30002',	'O30003',	'O30001',	'O30002',	'O30003',	'O30109',	'O30101',	'O30102',	'O30103',	'O30101',	'O30102',	'O30103',	'O30209',	'O30201',	'O30202',	'O30203',	'O30201',	'O30202',	'O30203',	'O3110X0',	'O3111X0',	'O3111X0',	'O3110X0',	'O3111X0',	'O3111X0',	'O3110X0',	'O3111X0',	'O3111X0',	'O3110X0',	'O3111X0',	'O3111X0',	'O3130X0',	'O3131X0',	'O3132X0',	'O3133X0',	'O3131X0',	'O3132X0',	'O3133X0',	'O30809',	'O30801',	'O30802',	'O30803',	'O318X10',	'O318X20',	'O318X30',	'O30801',	'O30802',	'O30803',	'O318X10',	'O318X20',	'O318X30',	'O3090',	'O318X90',	'O3091',	'O3092',	'O3093',	'O3091',	'O3092',	'O3093',	'O329XX0',	'O329XX0',	'O329XX0',	'O3421',	'O3421',	'O3421',	'O350XX0',	'O351XX0',	'O352XX0',	'O353XX0',	'O354XX0',	'O355XX0',	'O356XX0',	'O358XX0',	'O43011',	'O360110',	'O360120',	'O360130',	'O360910',	'O360920',	'O360930',	'O361110',	'O361120',	'O361130',	'O361910',	'O361920',	'O361930',	'O68',	'O68',	'O68',	'O365110',	'O365120',	'O365130',	'O365910',	'O365920',	'O365930',	'O3661X0',	'O3662X0',	'O3663X0',	'O43101',	'O43102',	'O43103',	'O43811',	'O43812',	'O43813',	'O4391',	'O4392',	'O4393',	'O368910',	'O368920',	'O368930',	'O68',	'O770',	'O3691X0',	'O3692X0',	'O3693X0',	'O401XX0',	'O402XX0',	'O403XX0',	'O4101X0',	'O4102X0',	'O4103X0',	'O4200',	'O42011',	'O42012',	'O42013',	'O4202',	'O4210',	'O42111',	'O42112',	'O42113',	'O4212',	'O411010',	'O411020',	'O411030',	'O411210',	'O411220',	'O411230',	'O411410',	'O411420',	'O411430',	'O418X10',	'O418X20',	'O418X30',	'O4191X0',	'O4192X0',	'O4193X0',	'O752',	'O752',	'O753',	'O753',	'O0940',	'O0941',	'O0942',	'O0943',	'O0941',	'O0942',	'O0943',	'O09511',	'O09512',	'O09513',	'O09529',	'O09521',	'O09522',	'O09523',	'O09521',	'O09522',	'O09523',	'O76',	'O76',	'O76',	'O7589',	'O759',	'O661',	'O661',	'O661',	'O632',	'O632',	'O632',	'O694XX0',	'O694XX0',	'O694XX0',	'O2251',	'O2252',	'O2253',	'O2291',	'O2292',	'O2293',	'O903',	'O903',	'O358XX0',	'O368210',	'O368220',	'O368230',	'O30029',	'O30021',	'O30022',	'O30023',	'O30021',	'O30022',	'O30023',	'P015',	'Z21',	'O0900',	'O0910',	'O09291',	'O0940',	'O09211',	'O0910',	'O09291',	'O09291',	'O0930',	'O09511',	'O09521',	'O09611',	'O09621',	'O09819',	'O09821',	'O09822',	'O09823',	'O09829',	'O3680X0',	'O09891',	'O09892',	'O09893',	'O09899',	'O0990',	'O0991',	'O0992',	'O0993',	'Z372',	'Z3759',	'Z640',	'Z640',	'O30009',	'O30019',	'O30039',	'O30049',	'O30099',	'O30109',	'O30119',	'O30129',	'O30199',	'O30209',	'O30219',	'O30229',	'O30299',	'O30809',	'O30819',	'O30829',	'O30899') and nomen  ='DXX' then 1 else 0 end))>0 then 1 else 0 end  as CSECT_RFs,
case when (sum(case when code_value in ('O4400',	'O4401',	'O4402',	'O4403',	'O4401',	'O4402',	'O4403',	'O4410',	'O4411',	'O4412',	'O4413',	'O4411',	'O4412',	'O4413',	'O458X1',	'O458X2',	'O458X3',	'O4591',	'O4592',	'O4593',	'O45001',	'O45002',	'O45003',	'O45011',	'O45012',	'O45013',	'O45021',	'O45022',	'O45023',	'O45091',	'O45092',	'O45093',	'O46001',	'O46002',	'O46003',	'O46011',	'O46012',	'O46013',	'O46021',	'O46022',	'O46023',	'O46091',	'O46092',	'O46093',	'O670',	'O468X1',	'O468X2',	'O468X3',	'O678',	'O4691',	'O4692',	'O4693',	'O679',	'O10011',	'O10012',	'O10013',	'O1002',	'O10911',	'O10912',	'O10913',	'O1092',	'O1003',	'O10411',	'O10412',	'O10413',	'O1042',	'O1043',	'O10111',	'O10112',	'O10113',	'O1012',	'O10211',	'O10212',	'O10213',	'O1022',	'O10311',	'O10312',	'O10313',	'O1032',	'O111',	'O112',	'O113',	'O1013',	'O131',	'O132',	'O133',	'O161',	'O162',	'O163',	'O131',	'O132',	'O133',	'O1402',	'O1403',	'O1492',	'O1493',	'O1402',	'O1403',	'O1412',	'O1413',	'O1422',	'O1423',	'O1412',	'O1413',	'O1422',	'O1423',	'O1412',	'O1413',	'O1422',	'O1423',	'O1502',	'O1503',	'O151',	'O152',	'O152',	'O111',	'O112',	'O113',	'O152',	'O152',	'O161',	'O162',	'O163',	'O169',	'O6010X0',	'O6012X0',	'O6013X0',	'O6014X0',	'O480',	'O1201',	'O1202',	'O1203',	'O1221',	'O1222',	'O1223',	'O2601',	'O2602',	'O2603',	'O1201',	'O1202',	'O1203',	'O26831',	'O26832',	'O26833',	'O26831',	'O26832',	'O26833',	'O2621',	'O2622',	'O2623',	'O2391',	'O2392',	'O2393',	'O2391',	'O2392',	'O2393',	'O26611',	'O26612',	'O26613',	'O2662',	'O98111',	'O98112',	'O98113',	'O9812',	'O9813',	'O98211',	'O98212',	'O98213',	'O9822',	'O9823',	'O98311',	'O98312',	'O98313',	'O9832',	'O9833',	'O98011',	'O98012',	'O98013',	'O9802',	'O9803',	'O98611',	'O98612',	'O98613',	'O9862',	'O9863',	'O98511',	'O98512',	'O98513',	'O9852',	'O9853',	'O9842',	'O98511',	'O98512',	'O98513',	'O9852',	'O9843',	'O9853',	'O98611',	'O98612',	'O98613',	'O98811',	'O98812',	'O98813',	'O9882',	'O99834',	'O9883',	'O99835',	'O98911',	'O98912',	'O98913',	'O9892',	'O9893',	'O2432',	'O24911',	'O24912',	'O24913',	'O2492',	'O2493',	'O99321',	'O99322',	'O99323',	'O99324',	'O99325',	'O99341',	'O99342',	'O99343',	'O99344',	'O906',	'O99345',	'O99411',	'O99412',	'O99413',	'O9942',	'O9943',	'O99411',	'O99412',	'O99413',	'O9942',	'O9943',	'O24419',	'O24429',	'O99810',	'O99814',	'O99815',	'O252',	'O99284',	'O99285',	'O99330',	'O99331',	'O99332',	'O99333',	'O99334',	'O99335',	'O99331',	'O99332',	'O99333',	'O99211',	'O99212',	'O99213',	'O99214',	'O99215',	'O99841',	'O99842',	'O99843',	'O99844',	'O99845',	'O99111',	'O99112',	'O99113',	'O9912',	'O9913',	'O99351',	'O99352',	'O99353',	'O99354',	'O99355',	'O30009',	'O30001',	'O30002',	'O30003',	'O30001',	'O30002',	'O30003',	'O30109',	'O30101',	'O30102',	'O30103',	'O30101',	'O30102',	'O30103',	'O30209',	'O30201',	'O30202',	'O30203',	'O30201',	'O30202',	'O30203',	'O3110X0',	'O3111X0',	'O3111X0',	'O3110X0',	'O3111X0',	'O3111X0',	'O3110X0',	'O3111X0',	'O3111X0',	'O3110X0',	'O3111X0',	'O3111X0',	'O3130X0',	'O3131X0',	'O3132X0',	'O3133X0',	'O3131X0',	'O3132X0',	'O3133X0',	'O30809',	'O30801',	'O30802',	'O30803',	'O318X10',	'O318X20',	'O318X30',	'O30801',	'O30802',	'O30803',	'O318X10',	'O318X20',	'O318X30',	'O3090',	'O318X90',	'O3091',	'O3092',	'O3093',	'O3091',	'O3092',	'O3093',	'O320XX0',	'O320XX0',	'O320XX0',	'O321XX0',	'O322XX0',	'O323XX0',	'O329XX0',	'O329XX0',	'O329XX0',	'O326XX0',	'O328XX0',	'O3400',	'O3401',	'O3402',	'O3403',	'O3410',	'O3411',	'O3412',	'O3413',	'O3421',	'O3421',	'O3421',	'O34519',	'O34539',	'O34511',	'O34512',	'O34513',	'O34531',	'O34532',	'O34533',	'O34529',	'O34599',	'O34521',	'O34522',	'O34523',	'O34591',	'O34592',	'O34593',	'O3440',	'O3441',	'O3442',	'O3443',	'O3460',	'O3461',	'O3462',	'O3463',	'O3470',	'O3471',	'O3472',	'O3473',	'O3480',	'O3490',	'O3429',	'O3481',	'O3482',	'O3483',	'O3491',	'O3492',	'O3493',	'O350XX0',	'O351XX0',	'O352XX0',	'O353XX0',	'O354XX0',	'O355XX0',	'O356XX0',	'O358XX0',	'O43011',	'O360110',	'O360120',	'O360130',	'O360910',	'O360920',	'O360930',	'O361110',	'O361120',	'O361130',	'O361910',	'O361920',	'O361930',	'O68',	'O68',	'O68',	'O365110',	'O365120',	'O365130',	'O365910',	'O365920',	'O365930',	'O3661X0',	'O3662X0',	'O3663X0',	'O43101',	'O43102',	'O43103',	'O43811',	'O43812',	'O43813',	'O4391',	'O4392',	'O4393',	'O368910',	'O368920',	'O368930',	'O68',	'O770',	'O3691X0',	'O3692X0',	'O3693X0',	'O401XX0',	'O402XX0',	'O403XX0',	'O4101X0',	'O4102X0',	'O4103X0',	'O4200',	'O42011',	'O42012',	'O42013',	'O4202',	'O4210',	'O42111',	'O42112',	'O42113',	'O4212',	'O411010',	'O411020',	'O411030',	'O411210',	'O411220',	'O411230',	'O411410',	'O411420',	'O411430',	'O418X10',	'O418X20',	'O418X30',	'O4191X0',	'O4192X0',	'O4193X0',	'O752',	'O752',	'O753',	'O753',	'O0940',	'O0941',	'O0942',	'O0943',	'O0941',	'O0942',	'O0943',	'O09511',	'O09512',	'O09513',	'O09529',	'O09521',	'O09522',	'O09523',	'O09521',	'O09522',	'O09523',	'O76',	'O76',	'O76',	'O7589',	'O759',	'O661',	'O661',	'O661',	'O632',	'O632',	'O632',	'O694XX0',	'O694XX0',	'O694XX0',	'O641XX0',	'O641XX0',	'O2251',	'O2252',	'O2253',	'O2291',	'O2292',	'O2293',	'O903',	'O903',	'O358XX0',	'O368210',	'O368220',	'O368230',	'O30029',	'O30021',	'O30022',	'O30023',	'O30021',	'O30022',	'O30023',	'P015',	'Z21',	'O0900',	'O0910',	'O09291',	'O0940',	'O09211',	'O0910',	'O09291',	'O09291',	'O0930',	'O09511',	'O09521',	'O09611',	'O09621',	'O09819',	'O09821',	'O09822',	'O09823',	'O09829',	'O3680X0',	'O09891',	'O09892',	'O09893',	'O09899',	'O0990',	'O0991',	'O0992',	'O0993',	'Z372',	'Z3759',	'Z640',	'Z640',	'O30009',	'O30019',	'O30039',	'O30049',	'O30099',	'O30109',	'O30119',	'O30129',	'O30199',	'O30209',	'O30219',	'O30229',	'O30299',	'O30809',	'O30819',	'O30829',	'O30899') and nomen ='DXX' then     1
     when code_value in ('10D07Z3','10D07Z4','10D07Z5','10D07Z6','10D07Z3','10D07Z4','10D07Z5','10D07Z6') and nomen ='PXX' then    1 else 0 end))>0 then 1 else 0 end  as VAGEL_RFs ,
case when (sum(case when code_value in ('A6004',	'A6004',	'O200',	'O200',	'O208',	'O208',	'O209',	'O209',	'O4400',	'O4401',	'O4402',	'O4403',	'O4401',	'O4402',	'O4403',	'O4410',	'O4411',	'O4412',	'O4413',	'O4411',	'O4412',	'O4413',	'O458X9',	'O458X1',	'O458X2',	'O458X3',	'O4591',	'O4592',	'O4593',	'O458X1',	'O458X2',	'O458X3',	'O4591',	'O4592',	'O4593',	'O46009',	'O46019',	'O46029',	'O46099',	'O45001',	'O45002',	'O45003',	'O45011',	'O45012',	'O45013',	'O45021',	'O45022',	'O45023',	'O45091',	'O45092',	'O45093',	'O46001',	'O46002',	'O46003',	'O46011',	'O46012',	'O46013',	'O46021',	'O46022',	'O46023',	'O46091',	'O46092',	'O46093',	'O670',	'O45001',	'O45002',	'O45003',	'O45011',	'O45012',	'O45013',	'O45021',	'O45022',	'O45023',	'O45091',	'O45092',	'O45093',	'O46001',	'O46002',	'O46003',	'O46011',	'O46012',	'O46013',	'O46021',	'O46022',	'O46023',	'O46091',	'O46092',	'O46093',	'O468X9',	'O468X1',	'O468X2',	'O468X3',	'O678',	'O468X1',	'O468X2',	'O468X3',	'O4690',	'O4691',	'O4692',	'O4693',	'O679',	'O4691',	'O4692',	'O4693',	'O10019',	'O10919',	'O10011',	'O10012',	'O10013',	'O1002',	'O10911',	'O10912',	'O10913',	'O1092',	'O1003',	'O10011',	'O10012',	'O10013',	'O10911',	'O10912',	'O10913',	'O10419',	'O10411',	'O10412',	'O10413',	'O10119',	'O10219',	'O10319',	'O119',	'O10111',	'O10112',	'O10113',	'O10211',	'O10212',	'O10213',	'O10311',	'O10312',	'O10313',	'O111',	'O112',	'O113',	'O139',	'O131',	'O132',	'O133',	'O161',	'O162',	'O163',	'O1400',	'O1490',	'O1402',	'O1403',	'O1492',	'O1493',	'O1410',	'O1420',	'O1412',	'O1413',	'O1422',	'O1423',	'O159',	'O1502',	'O1503',	'O119',	'O111',	'O112',	'O113',	'O169',	'O161',	'O162',	'O163',	'O6000',	'O6002',	'O6003',	'O4700',	'O479',	'O4702',	'O4703',	'O471',	'O6010X0',	'O480',	'O480',	'O481',	'O481',	'O3100X0',	'O3101X0',	'O3102X0',	'O3103X0',	'O3101X0',	'O3102X0',	'O3103X0',	'O1200',	'O1220',	'O2600',	'O1201',	'O1202',	'O1203',	'O1221',	'O1222',	'O1223',	'O2601',	'O2602',	'O2603',	'O1201',	'O1202',	'O1203',	'O1201',	'O1202',	'O1203',	'O1221',	'O1222',	'O1223',	'O2601',	'O2602',	'O2603',	'O26839',	'O26831',	'O26832',	'O26833',	'O26831',	'O26832',	'O26833',	'O26831',	'O26832',	'O26833',	'O2620',	'O2621',	'O2622',	'O2623',	'O2621',	'O2622',	'O2623',	'O2300',	'O2310',	'O2320',	'O2330',	'O2340',	'O23519',	'O23529',	'O23599',	'O2390',	'O2391',	'O2392',	'O2393',	'O2391',	'O2392',	'O2393',	'O26619',	'O26611',	'O26612',	'O26613',	'O2662',	'O26611',	'O26612',	'O26613',	'O98119',	'O98111',	'O98112',	'O98113',	'O98219',	'O98211',	'O98212',	'O98213',	'O98319',	'O98311',	'O98312',	'O98313',	'O98019',	'O9803',	'O98011',	'O98012',	'O98013',	'O98619',	'O98611',	'O98612',	'O98613',	'O98519',	'O98511',	'O98512',	'O98513',	'O98519',	'O98511',	'O98512',	'O98513',	'O98819',	'O98611',	'O98612',	'O98613',	'O98811',	'O98812',	'O98813',	'O98919',	'O98911',	'O98912',	'O98913',	'O24319',	'O2432',	'O24911',	'O24912',	'O24913',	'O2492',	'O2493',	'O24911',	'O24912',	'O24913',	'O99320',	'O99321',	'O99322',	'O99323',	'O99324',	'O99325',	'O99321',	'O99322',	'O99323',	'O99340',	'O99341',	'O99342',	'O99343',	'O99419',	'O99411',	'O99412',	'O99413',	'O9942',	'O9943',	'O99411',	'O99412',	'O99413',	'O99419',	'O99411',	'O99412',	'O99413',	'O9942',	'O9943',	'O99411',	'O99412',	'O99413',	'O99810',	'O24419',	'O24429',	'O99810',	'O99814',	'O99815',	'O24419',	'O99810',	'O2510',	'O252',	'O99284',	'O99285',	'O2511',	'O2512',	'O2513',	'O99281',	'O99282',	'O99283',	'O99330',	'O99331',	'O99332',	'O99333',	'O99210',	'O99211',	'O99212',	'O99213',	'O99214',	'O99215',	'O99211',	'O99212',	'O99213',	'O99840',	'O99841',	'O99842',	'O99843',	'O99844',	'O99845',	'O99841',	'O99842',	'O99843',	'O99119',	'O99111',	'O99112',	'O99113',	'O9912',	'O9913',	'O99111',	'O99112',	'O99113',	'O99350',	'O99351',	'O99352',	'O99353',	'O99354',	'O99355',	'O99351',	'O99352',	'O99353',	'O30009',	'O30001',	'O30002',	'O30003',	'O30109',	'O30101',	'O30102',	'O30103',	'O30209',	'O30201',	'O30202',	'O30203',	'O3110X0',	'O3111X0',	'O3110X0',	'O3111X0',	'O3110X0',	'O3111X0',	'O3110X0',	'O3111X0',	'O3130X0',	'O3131X0',	'O3132X0',	'O3133X0',	'O30809',	'O30801',	'O30802',	'O30803',	'O318X10',	'O318X20',	'O318X30',	'O3090',	'O318X90',	'O3091',	'O3092',	'O3093',	'O320XX0',	'O320XX0',	'O320XX0',	'O329XX0',	'O329XX0',	'O326XX0',	'O328XX0',	'O3400',	'O3401',	'O3402',	'O3403',	'O3410',	'O3411',	'O3412',	'O3413',	'O3421',	'O3421',	'O34519',	'O34539',	'O34511',	'O34512',	'O34513',	'O34531',	'O34532',	'O34533',	'O34529',	'O34599',	'O34521',	'O34522',	'O34523',	'O34591',	'O34592',	'O34593',	'O3440',	'O3441',	'O3442',	'O3443',	'O3460',	'O3461',	'O3462',	'O3463',	'O3470',	'O3471',	'O3472',	'O3473',	'O3480',	'O3490',	'O3429',	'O3481',	'O3482',	'O3483',	'O3491',	'O3492',	'O3493',	'O350XX0',	'O350XX0',	'O350XX0',	'O351XX0',	'O351XX0',	'O352XX0',	'O352XX0',	'O353XX0',	'O353XX0',	'O353XX0',	'O354XX0',	'O354XX0',	'O354XX0',	'O355XX0',	'O355XX0',	'O355XX0',	'O356XX0',	'O356XX0',	'O356XX0',	'O358XX0',	'O358XX0',	'O358XX0',	'O43019',	'O43011',	'O360190',	'O360990',	'O360110',	'O360120',	'O360130',	'O360910',	'O360920',	'O360930',	'O361190',	'O361990',	'O361110',	'O361120',	'O361130',	'O361910',	'O361920',	'O361930',	'O68',	'O68',	'O68',	'O364XX0',	'O364XX0',	'O365190',	'O365990',	'O365110',	'O365120',	'O365130',	'O365910',	'O365920',	'O365930',	'O365110',	'O365120',	'O365130',	'O365910',	'O365920',	'O365930',	'O3660X0',	'O3661X0',	'O3662X0',	'O3663X0',	'O3661X0',	'O3662X0',	'O3663X0',	'O43199',	'O43819',	'O43101',	'O43102',	'O43103',	'O43811',	'O43812',	'O43813',	'O4391',	'O4392',	'O4393',	'O368990',	'O68',	'O770',	'O368910',	'O368920',	'O368930',	'O68',	'O3690X0',	'O3691X0',	'O3692X0',	'O3693X0',	'O409XX0',	'O401XX0',	'O402XX0',	'O403XX0',	'O4100X0',	'O4101X0',	'O4102X0',	'O4103X0',	'O4200',	'O42011',	'O42012',	'O42013',	'O4210',	'O42111',	'O42112',	'O42113',	'O411090',	'O411290',	'O411490',	'O411010',	'O411020',	'O411030',	'O411210',	'O411220',	'O411230',	'O411410',	'O411420',	'O411430',	'O411010',	'O411020',	'O411030',	'O411210',	'O411220',	'O411230',	'O411410',	'O411420',	'O411430',	'O418X90',	'O418X10',	'O418X20',	'O418X30',	'O4190X0',	'O4191X0',	'O4192X0',	'O4193X0',	'O752',	'O752',	'O753',	'O753',	'O0940',	'O0941',	'O0942',	'O0943',	'O0941',	'O0942',	'O0943',	'O09519',	'O09511',	'O09512',	'O09513',	'O09511',	'O09512',	'O09513',	'O09529',	'O09521',	'O09522',	'O09523',	'O09521',	'O09522',	'O09523',	'O76',	'O76',	'O76',	'O7589',	'O7589',	'O7589',	'O759',	'O759',	'O759',	'O661',	'O661',	'O632',	'O632',	'O694XX0',	'O694XX0',	'O694XX0',	'O2251',	'O2252',	'O2253',	'O2291',	'O2292',	'O2293',	'O903',	'O903',	'O903',	'O903',	'O358XX0',	'O368290',	'O358XX0',	'O368210',	'O368220',	'O368230',	'O30029',	'O30021',	'O30022',	'O30023',	'P015',	'Z21',	'O0900',	'O0910',	'O09291',	'O0940',	'O09211',	'O0910',	'O09291',	'O09291',	'O0930',	'O09511',	'O09521',	'O09611',	'O09621',	'O09819',	'O09821',	'O09822',	'O09823',	'O09829',	'O3680X0',	'O09891',	'O09892',	'O09893',	'O09899',	'O0990',	'O0991',	'O0992',	'O0993',	'Z371',	'Z372',	'Z373',	'Z374',	'Z3759',	'Z3769',	'Z377',	'Z640',	'Z640',	'O30009',	'O30019',	'O30039',	'O30049',	'O30099',	'O30109',	'O30119',	'O30129',	'O30199',	'O30209',	'O30219',	'O30229',	'O30299',	'O30809',	'O30819',	'O30829',	'O30899') and nomen ='DXX' then   1 else 0 end))>0 then 1 else 0 end  as PREGN_RFs ,
case when (sum(case when  code_value = '0174' and nomen ='REV' then 1 else 0 end))>0 then 1 else 0 end  as NICU_LVL_4

from Test_Stock50K20160804.code
join claims_combined
on Test_Stock50K20160804.code.u_c_id=claims_combined.id
join assignment
on claims_combined.master_claim_id=assignment.master_claim_id
left join episode_builder_5_4_003.code_icd10
on Test_Stock50K20160804.code.code_value=episode_builder_5_4_003.code_icd10.value and Test_Stock50K20160804.code.nomen=episode_builder_5_4_003.code_icd10.TYPE_ID
left join episode_builder_5_4_003.group
on episode_builder_5_4_003.code_icd10.GROUP_ID=episode_builder_5_4_003.group.ID
where
 code_value in ('10D07Z3','10D07Z4','10D07Z5','10D07Z6','10D07Z3','10D07Z4','10D07Z5','10D07Z6') and nomen ='PXX' and left(master_episode_id,6) in ('EP1403','EP1404','EX1401','EX1502') or
 code_value in ('A6004',	'A6004',	'O200',	'O200',	'O208',	'O208',	'O209',	'O209',	'O4400',	'O4401',	'O4402',	'O4403',	'O4401',	'O4402',	'O4403',	'O4410',	'O4411',	'O4412',	'O4413',	'O4411',	'O4412',	'O4413',	'O458X9',	'O458X1',	'O458X2',	'O458X3',	'O4591',	'O4592',	'O4593',	'O458X1',	'O458X2',	'O458X3',	'O4591',	'O4592',	'O4593',	'O46009',	'O46019',	'O46029',	'O46099',	'O45001',	'O45002',	'O45003',	'O45011',	'O45012',	'O45013',	'O45021',	'O45022',	'O45023',	'O45091',	'O45092',	'O45093',	'O46001',	'O46002',	'O46003',	'O46011',	'O46012',	'O46013',	'O46021',	'O46022',	'O46023',	'O46091',	'O46092',	'O46093',	'O670',	'O45001',	'O45002',	'O45003',	'O45011',	'O45012',	'O45013',	'O45021',	'O45022',	'O45023',	'O45091',	'O45092',	'O45093',	'O46001',	'O46002',	'O46003',	'O46011',	'O46012',	'O46013',	'O46021',	'O46022',	'O46023',	'O46091',	'O46092',	'O46093',	'O468X9',	'O468X1',	'O468X2',	'O468X3',	'O678',	'O468X1',	'O468X2',	'O468X3',	'O4690',	'O4691',	'O4692',	'O4693',	'O679',	'O4691',	'O4692',	'O4693',	'O10019',	'O10919',	'O10011',	'O10012',	'O10013',	'O1002',	'O10911',	'O10912',	'O10913',	'O1092',	'O1003',	'O10011',	'O10012',	'O10013',	'O10911',	'O10912',	'O10913',	'O10419',	'O10411',	'O10412',	'O10413',	'O1042',	'O1043',	'O10411',	'O10412',	'O10413',	'O10119',	'O10219',	'O10319',	'O119',	'O10111',	'O10112',	'O10113',	'O1012',	'O10211',	'O10212',	'O10213',	'O1022',	'O10311',	'O10312',	'O10313',	'O1032',	'O111',	'O112',	'O113',	'O1013',	'O10111',	'O10112',	'O10113',	'O10211',	'O10212',	'O10213',	'O10311',	'O10312',	'O10313',	'O111',	'O112',	'O113',	'O139',	'O131',	'O132',	'O133',	'O161',	'O162',	'O163',	'O131',	'O132',	'O133',	'O131',	'O132',	'O133',	'O161',	'O162',	'O163',	'O1400',	'O1490',	'O1402',	'O1403',	'O1492',	'O1493',	'O1402',	'O1403',	'O1402',	'O1403',	'O1492',	'O1493',	'O1410',	'O1420',	'O1412',	'O1413',	'O1422',	'O1423',	'O1412',	'O1413',	'O1422',	'O1423',	'O1412',	'O1413',	'O1422',	'O1423',	'O1412',	'O1413',	'O1422',	'O1423',	'O159',	'O1502',	'O1503',	'O151',	'O152',	'O1502',	'O1503',	'O152',	'O119',	'O111',	'O112',	'O113',	'O152',	'O111',	'O112',	'O113',	'O152',	'O169',	'O161',	'O162',	'O163',	'O169',	'O161',	'O162',	'O163',	'O6000',	'O6002',	'O6003',	'O4700',	'O479',	'O4702',	'O4703',	'O471',	'O6010X0',	'O6012X0',	'O6013X0',	'O6014X0',	'O480',	'O480',	'O480',	'O481',	'O481',	'O3100X0',	'O3101X0',	'O3102X0',	'O3103X0',	'O3101X0',	'O3102X0',	'O3103X0',	'O1200',	'O1220',	'O2600',	'O1201',	'O1202',	'O1203',	'O1221',	'O1222',	'O1223',	'O2601',	'O2602',	'O2603',	'O1201',	'O1202',	'O1203',	'O1201',	'O1202',	'O1203',	'O1221',	'O1222',	'O1223',	'O2601',	'O2602',	'O2603',	'O26839',	'O26831',	'O26832',	'O26833',	'O26831',	'O26832',	'O26833',	'O26831',	'O26832',	'O26833',	'O2620',	'O2621',	'O2622',	'O2623',	'O2621',	'O2622',	'O2623',	'O2300',	'O2310',	'O2320',	'O2330',	'O2340',	'O23519',	'O23529',	'O23599',	'O2390',	'O2391',	'O2392',	'O2393',	'O2391',	'O2392',	'O2393',	'O2391',	'O2392',	'O2393',	'O26619',	'O26611',	'O26612',	'O26613',	'O2662',	'O26611',	'O26612',	'O26613',	'O98119',	'O98111',	'O98112',	'O98113',	'O9812',	'O9813',	'O98111',	'O98112',	'O98113',	'O98219',	'O98211',	'O98212',	'O98213',	'O9822',	'O9823',	'O98211',	'O98212',	'O98213',	'O98319',	'O98311',	'O98312',	'O98313',	'O9832',	'O9833',	'O98311',	'O98312',	'O98313',	'O98019',	'O98011',	'O98012',	'O98013',	'O9802',	'O9803',	'O98011',	'O98012',	'O98013',	'O98619',	'O98611',	'O98612',	'O98613',	'O9862',	'O9863',	'O98611',	'O98612',	'O98613',	'O98519',	'O98511',	'O98512',	'O98513',	'O9852',	'O9853',	'O98511',	'O98512',	'O98513',	'O98519',	'O9842',	'O98511',	'O98512',	'O98513',	'O9852',	'O9843',	'O9853',	'O98511',	'O98512',	'O98513',	'O98819',	'O98611',	'O98612',	'O98613',	'O98811',	'O98812',	'O98813',	'O9882',	'O99834',	'O9883',	'O99835',	'O98611',	'O98612',	'O98613',	'O98811',	'O98812',	'O98813',	'O98919',	'O98911',	'O98912',	'O98913',	'O9892',	'O9893',	'O98911',	'O98912',	'O98913',	'O24319',	'O2432',	'O24911',	'O24912',	'O24913',	'O2492',	'O2493',	'O24911',	'O24912',	'O24913',	'O99320',	'O99321',	'O99322',	'O99323',	'O99324',	'O99325',	'O99321',	'O99322',	'O99323',	'O99340',	'O99341',	'O99342',	'O99343',	'O99344',	'O906',	'O99345',	'O99341',	'O99342',	'O99343',	'O99419',	'O99411',	'O99412',	'O99413',	'O9942',	'O9943',	'O99411',	'O99412',	'O99413',	'O99419',	'O99411',	'O99412',	'O99413',	'O9942',	'O9943',	'O99411',	'O99412',	'O99413',	'O99810',	'O24419',	'O24429',	'O99810',	'O99814',	'O99815',	'O24419',	'O99810',	'O2510',	'O252',	'O99284',	'O99285',	'O2511',	'O2512',	'O2513',	'O99281',	'O99282',	'O99283',	'O99330',	'O99331',	'O99332',	'O99333',	'O99334',	'O99335',	'O99331',	'O99332',	'O99333',	'O99210',	'O99211',	'O99212',	'O99213',	'O99214',	'O99215',	'O99211',	'O99212',	'O99213',	'O99840',	'O99841',	'O99842',	'O99843',	'O99844',	'O99845',	'O99841',	'O99842',	'O99843',	'O99119',	'O99111',	'O99112',	'O99113',	'O9912',	'O9913',	'O99111',	'O99112',	'O99113',	'O99350',	'O99351',	'O99352',	'O99353',	'O99354',	'O99355',	'O99351',	'O99352',	'O99353',	'O30009',	'O30001',	'O30002',	'O30003',	'O30001',	'O30002',	'O30003',	'O30109',	'O30101',	'O30102',	'O30103',	'O30101',	'O30102',	'O30103',	'O30209',	'O30201',	'O30202',	'O30203',	'O30201',	'O30202',	'O30203',	'O3110X0',	'O3111X0',	'O3111X0',	'O3110X0',	'O3111X0',	'O3111X0',	'O3110X0',	'O3111X0',	'O3111X0',	'O3110X0',	'O3111X0',	'O3111X0',	'O3130X0',	'O3131X0',	'O3132X0',	'O3133X0',	'O3131X0',	'O3132X0',	'O3133X0',	'O30809',	'O30801',	'O30802',	'O30803',	'O318X10',	'O318X20',	'O318X30',	'O30801',	'O30802',	'O30803',	'O318X10',	'O318X20',	'O318X30',	'O3090',	'O318X90',	'O3091',	'O3092',	'O3093',	'O3091',	'O3092',	'O3093',	'O320XX0',	'O320XX0',	'O320XX0',	'O321XX0',	'O322XX0',	'O323XX0',	'O329XX0',	'O329XX0',	'O329XX0',	'O326XX0',	'O328XX0',	'O3400',	'O3401',	'O3402',	'O3403',	'O3410',	'O3411',	'O3412',	'O3413',	'O3421',	'O3421',	'O3421',	'O34519',	'O34539',	'O34511',	'O34512',	'O34513',	'O34531',	'O34532',	'O34533',	'O34529',	'O34599',	'O34521',	'O34522',	'O34523',	'O34591',	'O34592',	'O34593',	'O3440',	'O3441',	'O3442',	'O3443',	'O3460',	'O3461',	'O3462',	'O3463',	'O3470',	'O3471',	'O3472',	'O3473',	'O3480',	'O3490',	'O3429',	'O3481',	'O3482',	'O3483',	'O3491',	'O3492',	'O3493',	'O350XX0',	'O350XX0',	'O350XX0',	'O351XX0',	'O351XX0',	'O351XX0',	'O352XX0',	'O352XX0',	'O352XX0',	'O353XX0',	'O353XX0',	'O353XX0',	'O354XX0',	'O354XX0',	'O354XX0',	'O355XX0',	'O355XX0',	'O355XX0',	'O356XX0',	'O356XX0',	'O356XX0',	'O358XX0',	'O358XX0',	'O358XX0',	'O43019',	'O43011',	'O43011',	'O360190',	'O360990',	'O360110',	'O360120',	'O360130',	'O360910',	'O360920',	'O360930',	'O360110',	'O360120',	'O360130',	'O360910',	'O360920',	'O360930',	'O361190',	'O361990',	'O361110',	'O361120',	'O361130',	'O361910',	'O361920',	'O361930',	'O361110',	'O361120',	'O361130',	'O361910',	'O361920',	'O361930',	'O68',	'O68',	'O68',	'O364XX0',	'O364XX0',	'O364XX0',	'O365190',	'O365990',	'O365110',	'O365120',	'O365130',	'O365910',	'O365920',	'O365930',	'O365110',	'O365120',	'O365130',	'O365910',	'O365920',	'O365930',	'O3660X0',	'O3661X0',	'O3662X0',	'O3663X0',	'O3661X0',	'O3662X0',	'O3663X0',	'O43199',	'O43819',	'O43101',	'O43102',	'O43103',	'O43811',	'O43812',	'O43813',	'O4391',	'O4392',	'O4393',	'O43101',	'O43102',	'O43103',	'O43811',	'O43812',	'O43813',	'O4391',	'O4392',	'O4393',	'O368990',	'O68',	'O770',	'O368910',	'O368920',	'O368930',	'O68',	'O770',	'O368910',	'O368920',	'O368930',	'O68',	'O3690X0',	'O3691X0',	'O3692X0',	'O3693X0',	'O3691X0',	'O3692X0',	'O3693X0',	'O409XX0',	'O401XX0',	'O402XX0',	'O403XX0',	'O401XX0',	'O402XX0',	'O403XX0',	'O4100X0',	'O4101X0',	'O4102X0',	'O4103X0',	'O4101X0',	'O4102X0',	'O4103X0',	'O4200',	'O4200',	'O42011',	'O42012',	'O42013',	'O4202',	'O42011',	'O42012',	'O42013',	'O4210',	'O4210',	'O42111',	'O42112',	'O42113',	'O4212',	'O42111',	'O42112',	'O42113',	'O411090',	'O411290',	'O411490',	'O411010',	'O411020',	'O411030',	'O411210',	'O411220',	'O411230',	'O411410',	'O411420',	'O411430',	'O411010',	'O411020',	'O411030',	'O411210',	'O411220',	'O411230',	'O411410',	'O411420',	'O411430',	'O418X90',	'O418X10',	'O418X20',	'O418X30',	'O418X10',	'O418X20',	'O418X30',	'O4190X0',	'O4191X0',	'O4192X0',	'O4193X0',	'O4191X0',	'O4192X0',	'O4193X0',	'O752',	'O752',	'O753',	'O753',	'O0940',	'O0941',	'O0942',	'O0943',	'O0941',	'O0942',	'O0943',	'O09519',	'O09511',	'O09512',	'O09513',	'O09511',	'O09512',	'O09513',	'O09529',	'O09521',	'O09522',	'O09523',	'O09521',	'O09522',	'O09523',	'O76',	'O76',	'O76',	'O7589',	'O7589',	'O7589',	'O759',	'O759',	'O759',	'O661',	'O661',	'O661',	'O632',	'O632',	'O632',	'O694XX0',	'O694XX0',	'O694XX0',	'O641XX0',	'O641XX0',	'O2251',	'O2252',	'O2253',	'O2291',	'O2292',	'O2293',	'O903',	'O903',	'O903',	'O903',	'O358XX0',	'O368290',	'O358XX0',	'O368210',	'O368220',	'O368230',	'O358XX0',	'O368210',	'O368220',	'O368230',	'O30029',	'O30021',	'O30022',	'O30023',	'O30021',	'O30022',	'O30023',	'P015',	'Z21',	'O0900',	'O0910',	'O09291',	'O0940',	'O09211',	'O0910',	'O09291',	'O09291',	'O0930',	'O09511',	'O09521',	'O09611',	'O09621',	'O09819',	'O09821',	'O09822',	'O09823',	'O09829',	'O3680X0',	'O09891',	'O09892',	'O09893',	'O09899',	'O0990',	'O0991',	'O0992',	'O0993',	'Z371',	'Z372',	'Z373',	'Z374',	'Z3759',	'Z3769',	'Z377',	'Z640',	'Z640',	'O30009',	'O30019',	'O30039',	'O30049',	'O30099',	'O30109',	'O30119',	'O30129',	'O30199',	'O30209',	'O30219',	'O30229',	'O30299',	'O30809',	'O30819',	'O30829',	'O30899') and nomen ='DXX' and left(master_episode_id,6) in ('EP1403','EP1404','EX1401','EX1502') 
group by u_c_id,
claims_combined.member_id,
left(master_episode_id,6) ,
assignment.master_episode_id,
claims_combined.master_claim_id,
GROUP_ID,
episode_builder_5_4_003.group.name 


;

	
/*********************************************/		


TRUNCATE TABLE tmp_ann_mel;
TRUNCATE TABLE tmp_annids;
TRUNCATE TABLE tmp_annids_c;
TRUNCATE TABLE tmp_mel1;

/* The following code sets up the tmp_sub_association table
to get all the costs of episodes that have sub-associations within the same level (chains of parent>child>grandchild etc within the same level */

/* DROP TABLE tmp_uber; */

TRUNCATE TABLE tmp_uber;
TRUNCATE TABLE tmp_sub_association;

/* this gets all episode who do not have a parent at their level of association */
/*INSERT   INTO tmp_uber
SELECT
*
FROM association a1
WHERE parent_master_episode_id NOT IN
(
SELECT a2.child_master_episode_id FROM association a2
WHERE a2.association_level=a1.association_level
);

Breaking into separate queries per level because vertica can't to not in on correlated subquery
*/

INSERT /*+ direct */  INTO tmp_uber
SELECT
*
FROM association a1
WHERE parent_master_episode_id NOT IN
(
SELECT a2.child_master_episode_id FROM association a2
WHERE a2.association_level=2
)
AND a1.association_level=2;

INSERT /*+ direct */  INTO tmp_uber
SELECT
*
FROM association a1
WHERE parent_master_episode_id NOT IN
(
SELECT a2.child_master_episode_id FROM association a2
WHERE a2.association_level=3
)
AND a1.association_level=3;

INSERT /*+ direct */  INTO tmp_uber
SELECT
*
FROM association a1
WHERE parent_master_episode_id NOT IN
(
SELECT a2.child_master_episode_id FROM association a2
WHERE a2.association_level=4
)
AND a1.association_level=4;

INSERT /*+ direct */  INTO tmp_uber
SELECT
*
FROM association a1
WHERE parent_master_episode_id NOT IN
(
SELECT a2.child_master_episode_id FROM association a2
WHERE a2.association_level=5
)
AND a1.association_level=5;

/* this should get the grandchildren*/
INSERT /*+ direct */  INTO tmp_sub_association 
(uber_master_episode_id,
parent_master_episode_id,
child_master_episode_id,
association_type,
association_level,
association_count,
association_sub_level)
SELECT 
u.parent_master_episode_id AS uber_master_episode_id,
a.parent_master_episode_id,
a.child_master_episode_id,
a.association_type,
a.association_level,
a.association_count,
1 AS association_sub_level
FROM tmp_uber u
JOIN association a ON u.child_master_episode_id=a.parent_master_episode_id
AND a.association_level=u.association_level;

INSERT /*+ direct */  INTO tmp_sub_association
(uber_master_episode_id,
parent_master_episode_id,
child_master_episode_id,
association_type,
association_level,
association_count,
association_sub_level)
SELECT 
u.parent_master_episode_id AS uber_master_episode_id,
a.parent_master_episode_id,
a.child_master_episode_id,
a.association_type,
a.association_level,
a.association_count,
2 AS association_sub_level
FROM tmp_sub_association u
JOIN association a ON u.child_master_episode_id=a.parent_master_episode_id
AND a.association_level=u.association_level;


INSERT /*+ direct */  INTO tmp_sub_association
(uber_master_episode_id,
parent_master_episode_id,
child_master_episode_id,
association_type,
association_level,
association_count,
association_sub_level)
SELECT 
u.parent_master_episode_id AS uber_master_episode_id,
a.parent_master_episode_id,
a.child_master_episode_id,
a.association_type,
a.association_level,
a.association_count,
3 AS association_sub_level
FROM tmp_sub_association u
JOIN association a ON u.child_master_episode_id=a.parent_master_episode_id
AND a.association_level=u.association_level
AND u.association_sub_level=2;

INSERT /*+ direct */  INTO tmp_sub_association
(uber_master_episode_id,
parent_master_episode_id,
child_master_episode_id,
association_type,
association_level,
association_count,
association_sub_level)
SELECT 
u.parent_master_episode_id AS uber_master_episode_id,
a.parent_master_episode_id,
a.child_master_episode_id,
a.association_type,
a.association_level,
a.association_count,
4 AS association_sub_level
FROM tmp_sub_association u
JOIN association a ON u.child_master_episode_id=a.parent_master_episode_id
AND a.association_level=u.association_level
AND u.association_sub_level=3;

INSERT /*+ direct */  INTO tmp_sub_association
(uber_master_episode_id,
parent_master_episode_id,
child_master_episode_id,
association_type,
association_level,
association_count,
association_sub_level)
SELECT 
u.parent_master_episode_id AS uber_master_episode_id,
a.parent_master_episode_id,
a.child_master_episode_id,
a.association_type,
a.association_level,
a.association_count,
5 AS association_sub_level
FROM tmp_sub_association u
JOIN association a ON u.child_master_episode_id=a.parent_master_episode_id
AND a.association_level=u.association_level
AND u.association_sub_level=4;

INSERT /*+ direct */  INTO tmp_sub_association
(uber_master_episode_id,
parent_master_episode_id,
child_master_episode_id,
association_type,
association_level,
association_count,
association_sub_level)
SELECT 
u.parent_master_episode_id AS uber_master_episode_id,
a.parent_master_episode_id,
a.child_master_episode_id,
a.association_type,
a.association_level,
a.association_count,
6 AS association_sub_level
FROM tmp_sub_association u
JOIN association a ON u.child_master_episode_id=a.parent_master_episode_id
AND a.association_level=u.association_level
AND u.association_sub_level=5;

INSERT /*+ direct */  INTO tmp_sub_association
(uber_master_episode_id,
parent_master_episode_id,
child_master_episode_id,
association_type,
association_level,
association_count,
association_sub_level)
SELECT 
u.parent_master_episode_id AS uber_master_episode_id,
a.parent_master_episode_id,
a.child_master_episode_id,
a.association_type,
a.association_level,
a.association_count,
7 AS association_sub_level
FROM tmp_sub_association u
JOIN association a ON u.child_master_episode_id=a.parent_master_episode_id
AND a.association_level=u.association_level
AND u.association_sub_level=6;

INSERT /*+ direct */  INTO tmp_sub_association
(uber_master_episode_id,
parent_master_episode_id,
child_master_episode_id,
association_type,
association_level,
association_count,
association_sub_level)
SELECT 
u.parent_master_episode_id AS uber_master_episode_id,
a.parent_master_episode_id,
a.child_master_episode_id,
a.association_type,
a.association_level,
a.association_count,
8 AS association_sub_level
FROM tmp_sub_association u
JOIN association a ON u.child_master_episode_id=a.parent_master_episode_id
AND a.association_level=u.association_level
AND u.association_sub_level=7;

INSERT /*+ direct */  INTO tmp_sub_association
(uber_master_episode_id,
parent_master_episode_id,
child_master_episode_id,
association_type,
association_level,
association_count,
association_sub_level)
SELECT 
u.parent_master_episode_id AS uber_master_episode_id,
a.parent_master_episode_id,
a.child_master_episode_id,
a.association_type,
a.association_level,
a.association_count,
9 AS association_sub_level
FROM tmp_sub_association u
JOIN association a ON u.child_master_episode_id=a.parent_master_episode_id
AND a.association_level=u.association_level
AND u.association_sub_level=8;

INSERT /*+ direct */  INTO tmp_sub_association
(uber_master_episode_id,
parent_master_episode_id,
child_master_episode_id,
association_type,
association_level,
association_count,
association_sub_level)
SELECT 
u.parent_master_episode_id AS uber_master_episode_id,
a.parent_master_episode_id,
a.child_master_episode_id,
a.association_type,
a.association_level,
a.association_count,
10 AS association_sub_level
FROM tmp_sub_association u
JOIN association a ON u.child_master_episode_id=a.parent_master_episode_id
AND a.association_level=u.association_level
AND u.association_sub_level=9;

INSERT /*+ direct */  INTO tmp_sub_association
(uber_master_episode_id,
parent_master_episode_id,
child_master_episode_id,
association_type,
association_level,
association_count,
association_sub_level)
SELECT 
u.parent_master_episode_id AS uber_master_episode_id,
a.parent_master_episode_id,
a.child_master_episode_id,
a.association_type,
a.association_level,
a.association_count,
11 AS association_sub_level
FROM tmp_sub_association u
JOIN association a ON u.child_master_episode_id=a.parent_master_episode_id
AND a.association_level=u.association_level
AND u.association_sub_level=10;

INSERT /*+ direct */  INTO tmp_sub_association
(uber_master_episode_id,
parent_master_episode_id,
child_master_episode_id,
association_type,
association_level,
association_count,
association_sub_level)
SELECT 
u.parent_master_episode_id AS uber_master_episode_id,
a.parent_master_episode_id,
a.child_master_episode_id,
a.association_type,
a.association_level,
a.association_count,
12 AS association_sub_level
FROM tmp_sub_association u
JOIN association a ON u.child_master_episode_id=a.parent_master_episode_id
AND a.association_level=u.association_level
AND u.association_sub_level=11;

INSERT /*+ direct */  INTO tmp_sub_association
(uber_master_episode_id,
parent_master_episode_id,
child_master_episode_id,
association_type,
association_level,
association_count,
association_sub_level)
SELECT 
u.parent_master_episode_id AS uber_master_episode_id,
a.parent_master_episode_id,
a.child_master_episode_id,
a.association_type,
a.association_level,
a.association_count,
13 AS association_sub_level
FROM tmp_sub_association u
JOIN association a ON u.child_master_episode_id=a.parent_master_episode_id
AND a.association_level=u.association_level
AND u.association_sub_level=12;

INSERT /*+ direct */  INTO tmp_sub_association
(uber_master_episode_id,
parent_master_episode_id,
child_master_episode_id,
association_type,
association_level,
association_count,
association_sub_level)
SELECT 
u.parent_master_episode_id AS uber_master_episode_id,
a.parent_master_episode_id,
a.child_master_episode_id,
a.association_type,
a.association_level,
a.association_count,
14 AS association_sub_level
FROM tmp_sub_association u
JOIN association a ON u.child_master_episode_id=a.parent_master_episode_id
AND a.association_level=u.association_level
AND u.association_sub_level=13;

INSERT /*+ direct */  INTO tmp_sub_association
(uber_master_episode_id,
parent_master_episode_id,
child_master_episode_id,
association_type,
association_level,
association_count,
association_sub_level)
SELECT 
u.parent_master_episode_id AS uber_master_episode_id,
a.parent_master_episode_id,
a.child_master_episode_id,
a.association_type,
a.association_level,
a.association_count,
15 AS association_sub_level
FROM tmp_sub_association u
JOIN association a ON u.child_master_episode_id=a.parent_master_episode_id
AND a.association_level=u.association_level
AND u.association_sub_level=14;

INSERT /*+ direct */  INTO tmp_sub_association
(uber_master_episode_id,
parent_master_episode_id,
child_master_episode_id,
association_type,
association_level,
association_count,
association_sub_level)
SELECT 
u.parent_master_episode_id AS uber_master_episode_id,
a.parent_master_episode_id,
a.child_master_episode_id,
a.association_type,
a.association_level,
a.association_count,
16 AS association_sub_level
FROM tmp_sub_association u
JOIN association a ON u.child_master_episode_id=a.parent_master_episode_id
AND a.association_level=u.association_level
AND u.association_sub_level=15;

INSERT /*+ direct */  INTO tmp_sub_association
(uber_master_episode_id,
parent_master_episode_id,
child_master_episode_id,
association_type,
association_level,
association_count,
association_sub_level)
SELECT 
u.parent_master_episode_id AS uber_master_episode_id,
a.parent_master_episode_id,
a.child_master_episode_id,
a.association_type,
a.association_level,
a.association_count,
17 AS association_sub_level
FROM tmp_sub_association u
JOIN association a ON u.child_master_episode_id=a.parent_master_episode_id
AND a.association_level=u.association_level
AND u.association_sub_level=16;

INSERT /*+ direct */  INTO tmp_sub_association
(uber_master_episode_id,
parent_master_episode_id,
child_master_episode_id,
association_type,
association_level,
association_count,
association_sub_level)
SELECT 
u.parent_master_episode_id AS uber_master_episode_id,
a.parent_master_episode_id,
a.child_master_episode_id,
a.association_type,
a.association_level,
a.association_count,
18 AS association_sub_level
FROM tmp_sub_association u
JOIN association a ON u.child_master_episode_id=a.parent_master_episode_id
AND a.association_level=u.association_level
AND u.association_sub_level=17;

INSERT /*+ direct */  INTO tmp_sub_association
(uber_master_episode_id,
parent_master_episode_id,
child_master_episode_id,
association_type,
association_level,
association_count,
association_sub_level)
SELECT 
u.parent_master_episode_id AS uber_master_episode_id,
a.parent_master_episode_id,
a.child_master_episode_id,
a.association_type,
a.association_level,
a.association_count,
19 AS association_sub_level
FROM tmp_sub_association u
JOIN association a ON u.child_master_episode_id=a.parent_master_episode_id
AND a.association_level=u.association_level
AND u.association_sub_level=18;

INSERT /*+ direct */  INTO tmp_sub_association
(uber_master_episode_id,
parent_master_episode_id,
child_master_episode_id,
association_type,
association_level,
association_count,
association_sub_level)
SELECT 
u.parent_master_episode_id AS uber_master_episode_id,
a.parent_master_episode_id,
a.child_master_episode_id,
a.association_type,
a.association_level,
a.association_count,
20 AS association_sub_level
FROM tmp_sub_association u
JOIN association a ON u.child_master_episode_id=a.parent_master_episode_id
AND a.association_level=u.association_level
AND u.association_sub_level=19;

INSERT /*+ direct */  INTO tmp_sub_association
(uber_master_episode_id,
parent_master_episode_id,
child_master_episode_id,
association_type,
association_level,
association_count,
association_sub_level)
SELECT 
u.parent_master_episode_id AS uber_master_episode_id,
a.parent_master_episode_id,
a.child_master_episode_id,
a.association_type,
a.association_level,
a.association_count,
21 AS association_sub_level
FROM tmp_sub_association u
JOIN association a ON u.child_master_episode_id=a.parent_master_episode_id
AND a.association_level=u.association_level
AND u.association_sub_level=20;

INSERT /*+ direct */  INTO tmp_sub_association
(uber_master_episode_id,
parent_master_episode_id,
child_master_episode_id,
association_type,
association_level,
association_count,
association_sub_level)
SELECT 
u.parent_master_episode_id AS uber_master_episode_id,
a.parent_master_episode_id,
a.child_master_episode_id,
a.association_type,
a.association_level,
a.association_count,
22 AS association_sub_level
FROM tmp_sub_association u
JOIN association a ON u.child_master_episode_id=a.parent_master_episode_id
AND a.association_level=u.association_level
AND u.association_sub_level=21;

INSERT /*+ direct */  INTO tmp_sub_association
(uber_master_episode_id,
parent_master_episode_id,
child_master_episode_id,
association_type,
association_level,
association_count,
association_sub_level)
SELECT 
u.parent_master_episode_id AS uber_master_episode_id,
a.parent_master_episode_id,
a.child_master_episode_id,
a.association_type,
a.association_level,
a.association_count,
23 AS association_sub_level
FROM tmp_sub_association u
JOIN association a ON u.child_master_episode_id=a.parent_master_episode_id
AND a.association_level=u.association_level
AND u.association_sub_level=22;

INSERT /*+ direct */  INTO tmp_sub_association
(uber_master_episode_id,
parent_master_episode_id,
child_master_episode_id,
association_type,
association_level,
association_count,
association_sub_level)
SELECT 
u.parent_master_episode_id AS uber_master_episode_id,
a.parent_master_episode_id,
a.child_master_episode_id,
a.association_type,
a.association_level,
a.association_count,
24 AS association_sub_level
FROM tmp_sub_association u
JOIN association a ON u.child_master_episode_id=a.parent_master_episode_id
AND a.association_level=u.association_level
AND u.association_sub_level=23;

INSERT /*+ direct */  INTO tmp_sub_association
(uber_master_episode_id,
parent_master_episode_id,
child_master_episode_id,
association_type,
association_level,
association_count,
association_sub_level)
SELECT 
u.parent_master_episode_id AS uber_master_episode_id,
a.parent_master_episode_id,
a.child_master_episode_id,
a.association_type,
a.association_level,
a.association_count,
25 AS association_sub_level
FROM tmp_sub_association u
JOIN association a ON u.child_master_episode_id=a.parent_master_episode_id
AND a.association_level=u.association_level
AND u.association_sub_level=24;

INSERT /*+ direct */  INTO tmp_sub_association
(uber_master_episode_id,
parent_master_episode_id,
child_master_episode_id,
association_type,
association_level,
association_count,
association_sub_level)
SELECT 
u.parent_master_episode_id AS uber_master_episode_id,
a.parent_master_episode_id,
a.child_master_episode_id,
a.association_type,
a.association_level,
a.association_count,
26 AS association_sub_level
FROM tmp_sub_association u
JOIN association a ON u.child_master_episode_id=a.parent_master_episode_id
AND a.association_level=u.association_level
AND u.association_sub_level=25;

INSERT /*+ direct */  INTO tmp_sub_association
(uber_master_episode_id,
parent_master_episode_id,
child_master_episode_id,
association_type,
association_level,
association_count,
association_sub_level)
SELECT 
u.parent_master_episode_id AS uber_master_episode_id,
a.parent_master_episode_id,
a.child_master_episode_id,
a.association_type,
a.association_level,
a.association_count,
27 AS association_sub_level
FROM tmp_sub_association u
JOIN association a ON u.child_master_episode_id=a.parent_master_episode_id
AND a.association_level=u.association_level
AND u.association_sub_level=26;

INSERT /*+ direct */  INTO tmp_sub_association
(uber_master_episode_id,
parent_master_episode_id,
child_master_episode_id,
association_type,
association_level,
association_count,
association_sub_level)
SELECT 
u.parent_master_episode_id AS uber_master_episode_id,
a.parent_master_episode_id,
a.child_master_episode_id,
a.association_type,
a.association_level,
a.association_count,
28 AS association_sub_level
FROM tmp_sub_association u
JOIN association a ON u.child_master_episode_id=a.parent_master_episode_id
AND a.association_level=u.association_level
AND u.association_sub_level=27;

INSERT /*+ direct */  INTO tmp_sub_association
(uber_master_episode_id,
parent_master_episode_id,
child_master_episode_id,
association_type,
association_level,
association_count,
association_sub_level)
SELECT 
u.parent_master_episode_id AS uber_master_episode_id,
a.parent_master_episode_id,
a.child_master_episode_id,
a.association_type,
a.association_level,
a.association_count,
29 AS association_sub_level
FROM tmp_sub_association u
JOIN association a ON u.child_master_episode_id=a.parent_master_episode_id
AND a.association_level=u.association_level
AND u.association_sub_level=28;

INSERT /*+ direct */  INTO tmp_sub_association
(uber_master_episode_id,
parent_master_episode_id,
child_master_episode_id,
association_type,
association_level,
association_count,
association_sub_level)
SELECT 
u.parent_master_episode_id AS uber_master_episode_id,
a.parent_master_episode_id,
a.child_master_episode_id,
a.association_type,
a.association_level,
a.association_count,
30 AS association_sub_level
FROM tmp_sub_association u
JOIN association a ON u.child_master_episode_id=a.parent_master_episode_id
AND a.association_level=u.association_level
AND u.association_sub_level=29;

INSERT /*+ direct */  INTO tmp_sub_association
(uber_master_episode_id,
parent_master_episode_id,
child_master_episode_id,
association_type,
association_level,
association_count,
association_sub_level)
SELECT 
u.parent_master_episode_id AS uber_master_episode_id,
a.parent_master_episode_id,
a.child_master_episode_id,
a.association_type,
a.association_level,
a.association_count,
31 AS association_sub_level
FROM tmp_sub_association u
JOIN association a ON u.child_master_episode_id=a.parent_master_episode_id
AND a.association_level=u.association_level
AND u.association_sub_level=30;

UPDATE tmp_sub_association
SET association_sub_level_inv=
ABS(association_sub_level-(1+(SELECT max(association_sub_level) FROM tmp_sub_association)));

select * from tmp_sub_association;

drop table if exists Master_associations1;

/* level 2 looks good*/

create table Master_associations1 as
select
episode.master_episode_id as level_1,
case when tsa2.uber_master_episode_id is null and a2.child_master_episode_id is null then episode.master_episode_id
when tsa2.uber_master_episode_id is null  then a2.parent_master_episode_id else tsa2.uber_master_episode_id end
as level_2,
case when tsa3.uber_master_episode_id is null and a3.child_master_episode_id is null then episode.master_episode_id
when tsa3.uber_master_episode_id is null  then a3.parent_master_episode_id else tsa3.uber_master_episode_id end
   as level_3,
case when tsa4.uber_master_episode_id is null and a4.child_master_episode_id is null then episode.master_episode_id
when tsa4.uber_master_episode_id is null  then a4.parent_master_episode_id else tsa4.uber_master_episode_id end
   as level_4,
case when tsa5.uber_master_episode_id is null and a5.child_master_episode_id is null then episode.master_episode_id
when tsa5.uber_master_episode_id is null  then a5.parent_master_episode_id else tsa5.uber_master_episode_id end
   as level_5
from episode
left join association a2 on
episode.master_episode_id=a2.child_master_episode_id and a2.association_level=2
left join tmp_sub_association tsa2
on episode.master_episode_id=tsa2.child_master_episode_id  and tsa2.association_level=2


left join association a3 on
episode.master_episode_id=a3.child_master_episode_id and a3.association_level=3
left join tmp_sub_association tsa3
on episode.master_episode_id=tsa3.child_master_episode_id  and tsa3.association_level=3

left join association a4 on
episode.master_episode_id=a4.child_master_episode_id and a4.association_level=4
left join tmp_sub_association tsa4
on episode.master_episode_id=tsa4.child_master_episode_id  and tsa4.association_level=4

left join association a5 on
episode.master_episode_id=a5.child_master_episode_id and a5.association_level=5
left join tmp_sub_association tsa5
on episode.master_episode_id=tsa5.child_master_episode_id  and tsa5.association_level=5

;

drop table if exists Master_associations1;

/* level 2 looks good*/


drop table if exists Master_associations;
drop table if exists Master_associations1;

/* level 2 looks good*/

create table Master_associations1 as
select
member_id,
episode.master_episode_id as level_1,
case when tsa2.uber_master_episode_id is null and a2.child_master_episode_id is null then episode.master_episode_id
when tsa2.uber_master_episode_id is null  then a2.parent_master_episode_id else tsa2.uber_master_episode_id end
as level_2
from episode
left join association a2 on
episode.master_episode_id=a2.child_master_episode_id and a2.association_level=2
left join tmp_sub_association tsa2
on episode.master_episode_id=tsa2.child_master_episode_id  and tsa2.association_level=2
;

drop table if exists Master_associations2;

/* level 2 looks good*/

create table Master_associations2 as
select
member_id,
level_1,
level_2,
case when tsa3.uber_master_episode_id is null and a3.child_master_episode_id is null then level_2
when tsa3.uber_master_episode_id is null  then a3.parent_master_episode_id else tsa3.uber_master_episode_id end
   as level_3
from Master_associations1
left join association a3 on
Master_associations1.level_2=a3.child_master_episode_id and a3.association_level=3
left join tmp_sub_association tsa3
on Master_associations1.level_2=tsa3.child_master_episode_id  and tsa3.association_level=3
;

drop table if exists Master_associations3;

/* level 2 looks good*/

create table Master_associations3 as
select
member_id,
level_1,
level_2,
level_3,
case when tsa4.uber_master_episode_id is null and a4.child_master_episode_id is null then level_3
when tsa4.uber_master_episode_id is null  then a4.parent_master_episode_id else tsa4.uber_master_episode_id end
   as level_4
from Master_associations2
left join association a4 on
Master_associations2.level_3=a4.child_master_episode_id and a4.association_level=4
left join tmp_sub_association tsa4
on Master_associations2.level_3=tsa4.child_master_episode_id  and tsa4.association_level=4

;

drop table if exists Master_associations;

create table Master_associations as
select
member_id,
level_1,
level_2,
level_3,
level_4,
case when tsa4.uber_master_episode_id is null and a4.child_master_episode_id is null then level_4
when tsa4.uber_master_episode_id is null  then a4.parent_master_episode_id else tsa4.uber_master_episode_id end
   as level_5
from Master_associations3
left join association a4 on
Master_associations3.level_4=a4.child_master_episode_id and a4.association_level=5
left join tmp_sub_association tsa4
on Master_associations3.level_4=tsa4.child_master_episode_id  and tsa4.association_level=5

;

drop table if exists Master_associations1;
drop table if exists Master_associations2;
drop table if exists Master_associations3;

drop table if exists level_5;	
create table level_5 as	
select * from Master_associations;	
	
	

drop table if exists LEVEL_5c;	
create table LEVEL_5c as	
select	
level_5.*,	
episode.episode_end_date as Level_1_end	
from 	level_5
left join episode	
on level_5.LEVEL_1=episode.master_episode_id;	
	
drop table if exists LEVEL_5d;	
create table LEVEL_5d as	
select	
LEVEL_5c.*,	
episode.episode_end_date as Level_2_end	
from 	LEVEL_5c
left join episode	
on LEVEL_5c.LEVEL_2=episode.master_episode_id;	

drop table if exists LEVEL_5e;	
create table LEVEL_5e as	
select	
LEVEL_5d.*,	
episode.episode_end_date as Level_3_end	
from 	LEVEL_5d
left join episode	
on LEVEL_5d.LEVEL_3=episode.master_episode_id;	

drop table if exists LEVEL_5f;
create table LEVEL_5f as	
select	
LEVEL_5e.*,	
episode.episode_end_date as Level_4_end	
from 	LEVEL_5e
left join episode	
on LEVEL_5e.LEVEL_4=episode.master_episode_id;	
	
drop table if exists LEVEL_5_FINAL;
create table LEVEL_5_FINAL as	
select	
LEVEL_5f.*,	
episode.episode_end_date as Level_5_end	
from 	LEVEL_5f
left join episode	
on LEVEL_5f.LEVEL_5=episode.master_episode_id;	
	
drop table LEVEL_5c;	
drop table LEVEL_5d;	
drop table LEVEL_5e;	
drop table LEVEL_5f;	
	
select * from ALL_MAT_NBRON_FLAGs;

create table ALL_MAT_NBRON_FLAGs2 as
select
ALL_MAT_NBRON_FLAGs.*,
level_2,
level_5,
case when level_2 <> ALL_MAT_NBRON_FLAGs.master_episode_id then level_2
     when level_2 = ALL_MAT_NBRON_FLAGs.master_episode_id and left(ALL_MAT_NBRON_FLAGs.master_episode_id,2) = 'EP' then level_2
     when episode_id='EX1502' then master_episode_id
     when level_2 = ALL_MAT_NBRON_FLAGs.master_episode_id and left(ALL_MAT_NBRON_FLAGs.master_episode_id,6) = 'EX1401' then association.child_master_episode_id end as DELIVERY_EPISODE
from ALL_MAT_NBRON_FLAGs
left join LEVEL_5_FINAL al2 
on ALL_MAT_NBRON_FLAGs.master_episode_id=al2.LEVEL_1
left join association
on al2.LEVEL_2=association.parent_master_episode_id
group by ALL_MAT_NBRON_FLAGs.member_id, ALL_MAT_NBRON_FLAGs.episode_id, ALL_MAT_NBRON_FLAGs.master_episode_id, ALL_MAT_NBRON_FLAGs.master_claim_id, 
ALL_MAT_NBRON_FLAGs.RF_name, ALL_MAT_NBRON_FLAGs.CSECT_RFs, ALL_MAT_NBRON_FLAGs.VAGEL_RFs, ALL_MAT_NBRON_FLAGs.PREGN_RFs, ALL_MAT_NBRON_FLAGs.NICU_LVL_4, level_2,
level_5, association.child_master_episode_id, u_c_id, group_id;



create table filters_MAT_NBORN as
select
member_id,
left(DELIVERY_EPISODE,6) as episode_id,
DELIVERY_EPISODE as master_episode_id,
case when sum(case when left(DELIVERY_EPISODE,6)='EP1404' and RF_NAME in ('Placenta previa, vasa previa','Active Genital Herpes','Abnormal Presentation','Unstable Lie','Previous C-section','Multiple gestation','Stillbirth, Fetal Death','Multiparity, multigravida','Preterm','Prolonged / post-term pregnancy' )then 1 else 0 end )>0 then 1 else 0 end  as CSECT_WARRENTED_FILTER,
case when sum(case when RF_NAME in ('Placenta previa, vasa previa',	'Unstable Lie',	'Multiple gestation',	'Stillbirth, Fetal Death',	'Abnormalities of Amniotic Fluid ',	'ABO/Rh Isoimmunization',	'Amnionitis',	'Antepartum Hemorrhage',	'Cardiovascular disease in Mother',	'Coagulation Defects in Mother',	'Fetal abnormalities',	'High Risk Pregnancy, Bad obstetric History',	'High Risk Pregnancy, History of Fetal Loss',	'High Risk pregn, other serious medical disord',	'Poor Fetal Growth',	'Hypertension, pre-eclampsia in Pregnancy',	'Severe pre-eclampsia w HTN, Eclampsia',	'Maternal, gestational diabetes, large for date',	'HIV status',	'Fetal Distress’,’Prolonged / post-term pregnancy' )then 1 else 0 end )>0 then 1 else 0 end as INDUCTION_WARRANTED_FILTER,
case when sum(NICU_LVL_4)>0 then 1 else 0 end as NICU_LVL_4_FILTER

from ALL_MAT_NBRON_FLAGs2
group by member_id, DELIVERY_EPISODE;

